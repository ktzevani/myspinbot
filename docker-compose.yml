name: my-spin-bot

x-meta:
  maintainer: Kostas Tzevanidis <ktzevanid@gmail.com>
  description: >
    A fully local, open-source platform that turns user images and short audio clips into 
    personalized talking-bot videos. Runs LoRA, TTS, and diffusion (SadTalker/SVD) pipelines 
    via LangGraph, ComfyUI, and Ollama â€” all private, GPU-powered, and self-contained.

services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command: ["--configFile=/etc/traefik/traefik.yml"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/traefik_dynamic.yml:/etc/traefik/traefik_dynamic.yml:ro
      - ./traefik/data/letsencrypt:/letsencrypt
      - ./traefik/certs:/certs:ro
      - ./traefik/logs:/logs
      - ./traefik/secrets/htpasswd:/etc/traefik/htpasswd:ro
    networks: [internal-network]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`proxy.myspinbot.local`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth@file"

  prometheus:
    image: prom/prometheus:v3.0.0
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/data:/prometheus
    networks: [internal-network]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prom.rule=Host(`prometheus.myspinbot.local`)"
      - "traefik.http.routers.prom.entrypoints=websecure"
      - "traefik.http.routers.prom.tls=true"
      - "traefik.http.services.prom.loadbalancer.server.port=9090"
      - "traefik.http.routers.prom.middlewares=dashboard-auth@file"

  grafana:
    image: grafana/grafana:11.2.0
    container_name: grafana
    restart: unless-stopped
    user: "472"
    env_file:
      - .env
    environment:
      - GF_PATHS_DATA=/var/lib/grafana
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/dashboards
    networks: [internal-network]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.myspinbot.local`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.51.0
    container_name: cadvisor
    restart: unless-stopped
    command:
      - "--docker_only=true"
      - "--store_container_labels=false"
      - "--allow_dynamic_housekeeping=false"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - internal-network

  dcgm-exporter:
    image: nvidia/dcgm-exporter:4.4.0-4.5.0-ubuntu22.04
    container_name: dcgm-exporter
    restart: unless-stopped
    runtime: nvidia
    networks: [internal-network]

  redis:
    image: redis:8.2-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - internal-network
    volumes:
      - redis-data:/data
    command: ["redis-server", "--appendonly", "yes", "--maxmemory", "512mb", "--maxmemory-policy", "allkeys-lru"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"

  redis-exporter:
    image: oliver006/redis_exporter:v1.67.0
    container_name: redis-exporter
    restart: unless-stopped
    networks: [internal-network]
    environment:
      - REDIS_ADDR=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://redis-exporter:9121/metrics"]
      interval: 15s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"

  redis-insight:
    image: redis/redisinsight:2.70.1
    container_name: redis-insight
    restart: unless-stopped
    networks: [internal-network]
    volumes:
      - redis-insight-data:/data
      - ./redis-insight/databases.json:/data/databases.json:ro
    environment:
      - RI_PRE_SETUP_DATABASES_PATH=/data/databases.json
    depends_on:
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.redis.rule=Host(`redis.myspinbot.local`)"
      - "traefik.http.routers.redis.entrypoints=websecure"
      - "traefik.http.routers.redis.tls=true"
      - "traefik.http.services.redis.loadbalancer.server.port=5540"
      - "traefik.http.routers.redis.middlewares=dashboard-auth@file"

  api:
    build:
      context: ./backend
    container_name: myspinbot-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
    expose:
      - "3000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://api:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.myspinbot.local`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.services.api.loadbalancer.server.port=3000"
      - "traefik.http.services.api.loadbalancer.server.scheme=http"
      - "traefik.http.services.api.loadbalancer.passhostheader=true"
    networks:
      - internal-network
    depends_on:
      - traefik

  ui:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_URL: https://api.myspinbot.local
    container_name: myspinbot-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://api.myspinbot.local
    expose:
      - "3001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui.rule=Host(`ui.myspinbot.local`)"
      - "traefik.http.routers.ui.entrypoints=websecure"
      - "traefik.http.routers.ui.tls=true"
      - "traefik.http.services.ui.loadbalancer.server.port=3001"
      - "traefik.http.services.ui.loadbalancer.server.scheme=http"
      - "traefik.http.services.ui.loadbalancer.passhostheader=true"
    networks:
      - internal-network
    depends_on:
      - api
      - traefik

networks:
  internal-network:
    driver: bridge

volumes:
  redis-data:
  redis-insight-data: