name: myspinbot

x-meta:
  maintainer: Kostas Tzevanidis <ktzevanid@gmail.com>
  description: >
    A fully local, open-source platform that turns user images and short audio clips into 
    personalized talking-bot videos. Runs LoRA, TTS, and diffusion (SadTalker/SVD) pipelines 
    via LangGraph, ComfyUI, and Ollama â€” all private, GPU-powered, and self-contained.

services:
  traefik:
    image: traefik:v2.11
    container_name: myspinbot-proxy
    restart: unless-stopped
    command: ["--configFile=/etc/traefik/traefik.yml"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/traefik_dynamic.yml:/etc/traefik/traefik_dynamic.yml:ro
      - ./traefik/data/letsencrypt:/letsencrypt
      - ./traefik/certs:/certs:ro
      - ./traefik/logs:/logs
      - ./traefik/secrets/htpasswd:/etc/traefik/htpasswd:ro
    networks: [internal-network]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`proxy.myspinbot.local`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth@file"

  prometheus:
    image: prom/prometheus:v3.0.0
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/data:/prometheus
    networks: [internal-network]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prom.rule=Host(`prometheus.myspinbot.local`)"
      - "traefik.http.routers.prom.entrypoints=websecure"
      - "traefik.http.routers.prom.tls=true"
      - "traefik.http.services.prom.loadbalancer.server.port=9090"
      - "traefik.http.routers.prom.middlewares=dashboard-auth@file"
    profiles: ["observability"]

  grafana:
    image: grafana/grafana:11.2.0
    container_name: grafana
    restart: unless-stopped
    user: "472"
    env_file:
      - .env
    environment:
      - GF_PATHS_DATA=/var/lib/grafana
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/etc/grafana/dashboards
    networks: [internal-network]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.myspinbot.local`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
    profiles: ["observability"]
    depends_on:
      prometheus:
        condition: service_started

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.51.0
    container_name: cadvisor
    restart: unless-stopped
    command:
      - "--docker_only=true"
      - "--store_container_labels=false"
      - "--allow_dynamic_housekeeping=false"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - internal-network
    profiles: ["observability"]

  dcgm-exporter:
    image: nvidia/dcgm-exporter:4.4.0-4.5.0-ubuntu22.04
    container_name: dcgm-exporter
    restart: unless-stopped
    runtime: nvidia
    networks: [internal-network]
    profiles: ["observability"]

  redis:
    image: redis:8.2-alpine
    container_name: myspinbot-redis
    restart: unless-stopped
    networks:
      - internal-network
    volumes:
      - redis-data:/data
    command:
      [
        "redis-server",
        "--appendonly",
        "yes",
        "--maxmemory",
        "512mb",
        "--maxmemory-policy",
        "allkeys-lru",
      ]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"

  redis-exporter:
    image: oliver006/redis_exporter:v1.67.0
    container_name: myspinbot-redis-exporter
    restart: unless-stopped
    networks: [internal-network]
    environment:
      - REDIS_ADDR=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://redis-exporter:9121/metrics"]
      interval: 15s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"
    profiles: ["observability"]

  redis-insight:
    image: redis/redisinsight:2.70.1
    container_name: myspinbot-redis-insight
    restart: unless-stopped
    networks: [internal-network]
    volumes:
      - redis-insight-data:/data
      - ./redis-insight/databases.json:/data/databases.json:ro
    environment:
      - RI_PRE_SETUP_DATABASES_PATH=/data/databases.json
    depends_on:
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.redis.rule=Host(`redis.myspinbot.local`)"
      - "traefik.http.routers.redis.entrypoints=websecure"
      - "traefik.http.routers.redis.tls=true"
      - "traefik.http.services.redis.loadbalancer.server.port=5540"
      - "traefik.http.routers.redis.middlewares=dashboard-auth@file"

  api:
    image: myspinbot-backend:prod
    build:
      context: ./backend
      args:
        NODE_ENV: production
    container_name: myspinbot-backend
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://api:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.myspinbot.local`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.services.api.loadbalancer.server.port=3000"
      - "traefik.http.services.api.loadbalancer.server.scheme=http"
      - "traefik.http.services.api.loadbalancer.passhostheader=true"
    networks:
      - internal-network
    depends_on:
      redis:
        condition: service_healthy

  ui:
    image: myspinbot-frontend:prod
    build:
      context: ./frontend
      target: runtime
      args:
        NEXT_PUBLIC_API_URL: https://api.myspinbot.local
        NODE_ENV: production
    container_name: myspinbot-frontend
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui.rule=Host(`ui.myspinbot.local`)"
      - "traefik.http.routers.ui.entrypoints=websecure"
      - "traefik.http.routers.ui.tls=true"
      - "traefik.http.services.ui.loadbalancer.server.port=3001"
      - "traefik.http.services.ui.loadbalancer.server.scheme=http"
      - "traefik.http.services.ui.loadbalancer.passhostheader=true"
    networks:
      - internal-network
    depends_on:
      - api

  minio:
    image: quay.io/minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: minio
    entrypoint: ["/bin/sh", "/init.sh"]
    restart: unless-stopped
    env_file:
      - ./minio/config.env
      - ./minio/secrets/root.env
    volumes:
      - ./minio/init.sh:/init.sh:ro
      - minio-data:/data
    networks:
      - internal-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`s3.myspinbot.local`)"
      - "traefik.http.routers.minio.entrypoints=websecure"
      - "traefik.http.routers.minio.tls=true"
      - "traefik.http.services.minio.loadbalancer.server.port=9001"

  worker:
    build:
      context: ./worker
      args:
        WORKER_ENVIRONMENT: production
    image: myspinbot/worker:prod
    container_name: myspinbot-worker
    restart: unless-stopped
    networks:
      - internal-network
    depends_on:
      - redis
      - minio
    security_opt:
      - "apparmor:unconfined"
    cap_add:
      - SYS_PTRACE
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    env_file:
      - ./minio/secrets/root.env
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_BUCKETS=loras,voices,videos
      - MINIO_USE_SSL=false
    volumes:
      - models-cache:/opt/models
    gpus: all

networks:
  internal-network:
    driver: bridge

volumes:
  redis-data:
  redis-insight-data:
  minio-data:
  models-cache:
